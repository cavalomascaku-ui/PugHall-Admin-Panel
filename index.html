<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PugHall | Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<style>
:root{
--bg:#1a1512;
--accent:#e67e22;
--pug-tan:#d2b48c;
--card:rgba(30, 24, 20, 0.85);
--border:#3e2f26;
--gold:#f1c40f;
--red:#e74c3c;
--green:#2ecc71;
--font-title: 'Fredoka', sans-serif;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

body{
    margin:0;
    font-family:Inter,sans-serif;
    background:var(--bg);
    color:#fff;
    min-height: 100vh;
    position: relative;
}

body::before {
    content: "";
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-image: url('https://i.imgur.com/rM43tnX.jpeg');
    background-size: cover; background-position: center;
    opacity: 0.15; z-index: -1; pointer-events: none;
}

header{
    display:flex; justify-content:space-between; align-items:center;
    padding:15px 30px; background:rgba(26, 21, 18, 0.95);
    backdrop-filter: blur(15px); border-bottom:3px solid var(--red);
    position:sticky; top:0; z-index:100;
}

.logo{
    font-family: var(--font-title); font-weight:700; font-size:1.8rem;
    color:var(--red); display: flex; align-items: center; gap: 8px;
}
.logo span { color: #fff; }

.main{padding:40px;max-width:1400px;margin:auto;}
.section-title{font-family:var(--font-title);font-size:1.5rem;margin-bottom:20px;display:flex;align-items:center;gap:10px;color:var(--pug-tan)}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:25px;}

.card{
    background:var(--card); border-radius:20px; overflow:hidden;
    border:2px solid var(--border); transition:.3s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column;
}
.card:hover{transform:translateY(-5px); border-color:var(--accent);}

.card-media img {width:100%;height:180px;object-fit:cover;}

.card-body{padding:15px; flex: 1; display: flex; flex-direction: column; gap: 8px;}
.card-title{font-weight:900;text-transform:uppercase; font-size: 1.1rem;}
.card-meta{font-size:12px;opacity:.7; display:flex; gap:10px; align-items:center; color: var(--pug-tan);}

.tech-info {
    background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px;
    font-family: monospace; font-size: 11px; color: #888; margin-top: auto;
}

.admin-actions {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    padding: 15px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border);
}

.btn {
    border: none; padding: 12px; border-radius: 8px; font-weight: 800;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    gap: 8px; transition: 0.2s; color: #fff;
}
.btn:hover { transform: scale(1.05); }
.btn-approve { background: var(--green); color: #000; }
.btn-reject { background: var(--red); }
.btn-preview { background: #333; width: 100%; margin-top: 10px; }

.player{position:fixed;inset:0;background:#050403;display:none;flex-direction:column;z-index:2000;}
.player-header{padding:10px 20px;background:#111;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;}
iframe{width:100%;flex:1;border:none;background:#000;}

.empty-state { grid-column: 1/-1; text-align: center; padding: 50px; opacity: 0.5; }
</style>
</head>
<body>

<header>
    <div class="logo"><i data-lucide="shield-alert"></i> PUG<span>ADMIN</span></div>
    <div style="display:flex; gap:10px">
        <button class="btn" id="btn-notify" style="background:#333" onclick="enableNotifications()">
            <i data-lucide="bell"></i> ATIVAR NOTIFICA√á√ïES
        </button>
    </div>
</header>

<div class="main">
    <h2 class="section-title"><i data-lucide="list-checks"></i> FILA DE APROVA√á√ÉO</h2>
    <div id="list" class="grid">
        <div class="empty-state">Carregando fila...</div>
    </div>
</div>

<div class="player" id="player">
    <div class="player-header">
        <span id="gameTitle" style="font-weight:bold; color:#fff">TESTANDO...</span>
        <button class="btn btn-reject" onclick="closeGame()">FECHAR</button>
    </div>
    <iframe id="frame" allowfullscreen></iframe>
</div>

<script>
// --- AUDIO E CONFIGURA√á√ÉO ---
const barkSound = new Audio('https://www.myinstants.com/media/sounds/dog-bark.mp3');
const _0xgh = (s) => atob(s);

const firebaseConfig = {
  apiKey: _0xgh("QUl6YVN5Q2hQUkpYQS1xTlpCVk02b29FY2pVYkI3OXhSVzFYTkFN"),
  authDomain: _0xgh("b255eGNoYXQtOGFkNmYuZmlyZWJhc2VhcHAuY29t"),
  projectId: _0xgh("b255eGNoYXQtOGFkNmY="),
  storageBucket: _0xgh("b255eGNoYXQtOGFkNmYuZmlyZWJhc2VzdG9yYWdlLmFwcA=="),
  messagingSenderId: _0xgh("ODk2NDM0NTU1Njk2"),
  appId: _0xgh("MTo4OTY0MzQ1NTU2OTY6d2ViOjc2ZGE2YWVmOTYyZTM5MTZkODE2ZjU="),
  measurementId: _0xgh("Ry1TRkpKSEM1UE04")
};

let app = firebase.initializeApp(firebaseConfig, "PugAdmin");
const db = app.firestore();
let isFirstLoad = true;

// --- SISTEMA DE BADGE E NOTIFICA√á√ÉO ---
async function updateBadge(count) {
    if ('setAppBadge' in navigator) {
        if (count > 0) {
            navigator.setAppBadge(count).catch(e => console.log(e));
        } else {
            navigator.clearAppBadge().catch(e => console.log(e));
        }
    }
}

function notifyNewGame(title, author, img) {
    if (Notification.permission === "granted") {
        barkSound.play().catch(() => {}); // Latido!
        
        new Notification("üö® NOVO JOGO!", {
            body: `${title} por ${author}`,
            icon: img || 'https://i.imgur.com/rM43tnX.jpeg',
            vibrate: [200, 100, 200]
        });
    }
}

window.enableNotifications = () => {
    Notification.requestPermission().then(permission => {
        if (permission === "granted") {
            updateNotifyBtn();
            barkSound.play(); // Testa o som ao ativar
        }
    });
};

function updateNotifyBtn() {
    const btn = document.getElementById('btn-notify');
    if(btn && Notification.permission === "granted") {
        btn.style.background = "var(--green)";
        btn.style.color = "#000";
        btn.innerHTML = `<i data-lucide="bell-ring"></i> NOTIFICA√á√ïES ATIVAS`;
        lucide.createIcons();
    }
}

// --- RENDERIZA√á√ÉO E FILTRO ---
db.collection("games").where("published", "==", false).onSnapshot(snap => {
    // Atualiza a Badge com o n√∫mero de jogos pendentes
    updateBadge(snap.size);

    if (!isFirstLoad) {
        snap.docChanges().forEach(change => {
            if (change.type === "added") {
                const d = change.doc.data();
                notifyNewGame(d.title, d.author, d.img);
            }
        });
    }

    const list = document.getElementById('list');
    list.innerHTML = "";

    if(snap.empty) {
        list.innerHTML = `<div class="empty-state"><h3>Tudo limpo, chefe!</h3></div>`;
        isFirstLoad = false;
        return;
    }

    snap.forEach(doc => {
        const g = doc.data();
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
            <div class="card-media"><img src="${g.img}"></div>
            <div class="card-body">
                <div class="card-title">${g.title}</div>
                <div class="card-meta"><i data-lucide="user"></i> ${g.author}</div>
                <button class="btn btn-preview" onclick="openPreview('${g.url}', '${g.title}')">TESTAR JOGO</button>
            </div>
            <div class="admin-actions">
                <button class="btn btn-reject" onclick="reject('${doc.id}')">LIXO</button>
                <button class="btn btn-approve" onclick="approve('${doc.id}')">APROVAR</button>
            </div>
        `;
        list.appendChild(el);
    });
    lucide.createIcons();
    isFirstLoad = false;
}, err => console.error(err));

// --- A√á√ïES ---
async function approve(id) {
    if(confirm("Publicar jogo?")) await db.collection("games").doc(id).update({published: true});
}

async function reject(id) {
    if(confirm("Deletar jogo?")) await db.collection("games").doc(id).delete();
}

window.openPreview = (url, title) => {
    document.getElementById('player').style.display = 'flex';
    document.getElementById('frame').src = url;
    document.getElementById('gameTitle').innerText = title;
};

window.closeGame = () => {
    document.getElementById('player').style.display = 'none';
    document.getElementById('frame').src = '';
};

// Auto-check permiss√£o
if (Notification.permission === "granted") updateNotifyBtn();
</script>
</body>
</html>
